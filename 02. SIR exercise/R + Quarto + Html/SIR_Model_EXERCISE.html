<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ben Lopman REPLACE WITH YOUR NAME HERE">

<title>EPI 569 – Homework 2: Modeling a directly-transmitted pathogen</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="SIR_Model_EXERCISE_files/libs/clipboard/clipboard.min.js"></script>
<script src="SIR_Model_EXERCISE_files/libs/quarto-html/quarto.js"></script>
<script src="SIR_Model_EXERCISE_files/libs/quarto-html/popper.min.js"></script>
<script src="SIR_Model_EXERCISE_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="SIR_Model_EXERCISE_files/libs/quarto-html/anchor.min.js"></script>
<link href="SIR_Model_EXERCISE_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="SIR_Model_EXERCISE_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="SIR_Model_EXERCISE_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="SIR_Model_EXERCISE_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="SIR_Model_EXERCISE_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">EPI 569 – Homework 2: Modeling a directly-transmitted pathogen</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ben Lopman REPLACE WITH YOUR NAME HERE </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(deSolve)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="background-1" class="level2">
<h2 class="anchored" data-anchor-id="background-1">Background 1</h2>
<ul>
<li>A new pathogen has emerged in the Republic of Zubrowka. Here’s what we know so far:
<ul>
<li>All individuals are initially susceptible and become infected by contact with an infected person</li>
<li>People are symptomatic infectious for a while and then become immune</li>
<li>Immunity eventually wanes.</li>
</ul></li>
<li>We can partition our population of size (N) into susceptible (S), infected (I), and immune (R) people. So, N = S + I + R. These are our state variables: S, I and R.</li>
<li>Below, you will draw a diagram of the model and will also write out the model as a system of equations. To do that, we will also need the following information as parameters:
<ul>
<li><span class="math inline">\(\mu\)</span> is the birth and death rate, maintaining constant population size;</li>
<li><span class="math inline">\(\omega\)</span> is the rate at which immunity is lost;</li>
<li><span class="math inline">\(\sigma\)</span> is the recovery rate, and</li>
<li><span class="math inline">\(\delta_t\)</span> is the interval between successive calculations or time-step.</li>
<li><span class="math inline">\(\lambda\)</span> is the force (or rate) of infection per susceptible person. Which is:
<ul>
<li>contact rate, <span class="math inline">\(\alpha\)</span>, multiplied by</li>
<li>the probability of infection on contact with an infectious person <span class="math inline">\(\beta\)</span>, multiplied by</li>
<li>the probability that a randomly encountered person is infectious, <span class="math inline">\(\frac{I_{t-1}}{N}\)</span>.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="question-1-1pt" class="level2">
<h2 class="anchored" data-anchor-id="question-1-1pt">Question 1 <strong>(1pt)</strong></h2>
<ul>
<li>Draw a flow diagram of this transmission process. Include all the state variables (i.e., compartments) and arrows illustrating the flows in and out of the states.</li>
<li>You can insert the picture into your markdown file using the following code <!-- ![](filename.xyx) --> , or just upload as a separate file to Canvas when you turn in your work</li>
</ul>
<!-- -->
<ul>
<li><strong>ANSWER</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Add your figure here</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#knitr::include_graphics("FILENAME.png")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="question-2-1pt" class="level2">
<h2 class="anchored" data-anchor-id="question-2-1pt">Question 2 <strong>(1pt)</strong></h2>
<ul>
<li><p>Now, write the model down as a system of <strong>differential</strong> equations. You may use the Equation editor in Word, markdown in R/quarto (see <a href="https://rmd4sci.njtierney.com/math">here</a> for help) or another program of your choosing. You can also hand write and insert a picture.</p></li>
<li><p><em>Go through these equations to ensure that you understand what each term implies about the epidemiology of infection. You can also review the formulas in a<a href="https://github.com/blopman/epi569/blob/master/SIR_model_exercise.xlsx">n Excel spreadsheet version of this model</a>. Note that those are difference (not differential) equations</em></p></li>
<li><p><strong>ANSWER</strong><br>
</p></li>
</ul>
</section>
<section id="background-2" class="level2">
<h2 class="anchored" data-anchor-id="background-2">Background 2</h2>
<ul>
<li><p>Before moving on, have a look at the Excel spreadsheet version of the model that uses difference equations. In that version, you can easily see what’s going on the model. For the rest of the exercise, we’ll be using an <em>R</em> version of the model (below, embedded in this script) that uses differential equations. Add the parameter values to the spreadsheet or <em>R</em> script. Use values that seem sensible to you. Remember to keep all in the same units (days). For now, set the waning rate <span class="math inline">\(\omega\)</span> to 0 (this mean that there is lifelong immunity) and the mortality rate <span class="math inline">\(\mu\)</span> to 0 (i.e.&nbsp;no births/ deaths/ migrations).</p></li>
<li><p><em>Conceptual note: In models with constant per capita rates, the time spent in a compartment is exponentially distributed, so the mean ‘residence times’ are reciprocals of the exit rates or vice versa. For example,</em> <span class="math inline">\(\sigma\)</span> is the reciprocal (i.e.&nbsp;1/d) of the duration of illness.</p></li>
</ul>
</section>
<section id="background-3-model-parameters" class="level2">
<h2 class="anchored" data-anchor-id="background-3-model-parameters">Background 3 – Model parameters</h2>
<ul>
<li>You’ll use the parameter values below for questions 4 and 6</li>
</ul>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Parameter</th>
<th>Symbol</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Daily contact rate</td>
<td><span class="math inline">\(\alpha\)</span></td>
<td>5.0</td>
</tr>
<tr class="even">
<td>Transmission probability</td>
<td><span class="math inline">\(\beta\)</span></td>
<td>0.1</td>
</tr>
<tr class="odd">
<td>Recovery rate</td>
<td><span class="math inline">\(\sigma\)</span></td>
<td>0.2</td>
</tr>
<tr class="even">
<td>Loss of immunity rate</td>
<td><span class="math inline">\(\omega\)</span></td>
<td>0</td>
</tr>
<tr class="odd">
<td>Birth and death rate</td>
<td><span class="math inline">\(\mu\)</span></td>
<td>0</td>
</tr>
</tbody>
</table>
</section>
<section id="question-3-1pt" class="level2">
<h2 class="anchored" data-anchor-id="question-3-1pt">Question 3 <strong>(1pt)</strong></h2>
<ul>
<li><p>Another way to express the basic reproduction number is <span class="math inline">\(R_{0}=\frac{\alpha \beta}{\mu +\sigma}\)</span></p></li>
<li><p>Explain this in words. <em>Hint: What are</em> <span class="math inline">\(\alpha \beta\)</span> and <span class="math inline">\(\frac{1}{\mu +\sigma}\)</span>? Again, remember that the mortality rate <span class="math inline">\({\mu}\)</span> is zero (so far).</p></li>
<li><p><strong>ANSWER</strong></p></li>
</ul>
</section>
<section id="question-4-1pt" class="level2">
<h2 class="anchored" data-anchor-id="question-4-1pt">Question 4 <strong>(1pt)</strong></h2>
<ul>
<li><p>Calculate the basic reproductive number for your model.</p></li>
<li><p><strong>ANSWER</strong></p></li>
</ul>
</section>
<section id="question-5-1pt" class="level2">
<h2 class="anchored" data-anchor-id="question-5-1pt">Question 5 <strong>(1pt)</strong></h2>
<ul>
<li><p>If the initial conditions are <span class="math inline">\(S_{0}\)</span> = 100, <span class="math inline">\(I_{0}\)</span> = 0, and <span class="math inline">\(R_{0}\)</span> = 0, what does this say about the composition of the population at t = 0?</p></li>
<li><p><strong>ANSWER</strong></p></li>
</ul>
</section>
<section id="background-4" class="level2">
<h2 class="anchored" data-anchor-id="background-4">Background 4</h2>
<ul>
<li>Here we have the model in R. It consists of:
<ul>
<li>parameters (<em>parms</em>),</li>
<li>initial conditions (<em>init</em>),</li>
<li>the model as ordinary differential equations (<em>sir_ode</em>).</li>
</ul></li>
<li>Then the model creates output (<em>sir_out</em>) and is graphed (<em>using ggplot</em>)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define parameters -- THESE ARE THE MODEL PARAMETERS</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">alpha =</span><span class="dv">5</span>,        <span class="co"># alpha = daily contacts</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">beta=</span><span class="fl">0.1</span>,        <span class="co"># beta = probability of infection on contact</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">sigma=</span><span class="fl">0.2</span>,       <span class="co"># sigma = rate of recovery per day</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">mu =</span> <span class="fl">0.0</span>,        <span class="co"># mu =  per capita birth and death rate</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">omega =</span> <span class="fl">0.0</span>)     <span class="co"># omega = rate of immune loss per day</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial conditions --  THESE ARE THE CONDITIONS AT THE START OF THE SIMULATION</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S=</span><span class="dv">99</span>,           <span class="co"># number initially susceptible</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">I=</span><span class="dv">1</span>,            <span class="co"># number initially infectious</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">R=</span><span class="dv">0</span>)            <span class="co"># initially immune or "recovered"</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Define model equations -- do not change -- or change with care!</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># These are the model equations.  They are written as a function called sir_ode.  </span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># "parms" and "init" input the parameters and inital conditions into the equations </span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>sir_ode <span class="ot">&lt;-</span> <span class="cf">function</span>(times,init,parms){</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(parms,init)), {</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ODEs</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    dS <span class="ot">&lt;-</span> mu<span class="sc">*</span>(S<span class="sc">+</span>I<span class="sc">+</span>R) <span class="sc">+</span> omega<span class="sc">*</span>R <span class="sc">-</span>alpha<span class="sc">*</span>beta<span class="sc">*</span>I<span class="sc">*</span>S<span class="sc">/</span>(S<span class="sc">+</span>I<span class="sc">+</span>R) <span class="sc">-</span> mu<span class="sc">*</span>S </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    dI <span class="ot">&lt;-</span> alpha<span class="sc">*</span>beta<span class="sc">*</span>I<span class="sc">*</span>S<span class="sc">/</span>(S<span class="sc">+</span>I<span class="sc">+</span>R)<span class="sc">-</span>sigma<span class="sc">*</span>I <span class="sc">-</span> mu<span class="sc">*</span>I</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    dR <span class="ot">&lt;-</span> sigma<span class="sc">*</span>I  <span class="sc">-</span> omega<span class="sc">*</span>R <span class="sc">-</span> mu<span class="sc">*</span>R</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="fu">c</span>(dS,dI,dR))</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># This creates the output from model equations.  </span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">#If you want to run the model for longer, change the second term eg: seq(0,200,...)</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">100</span>,<span class="at">length.out=</span><span class="dv">100</span>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>sir_out <span class="ot">&lt;-</span> <span class="fu">lsoda</span>(init,times,sir_ode,parms)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>sir_out_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(<span class="fu">as.data.frame</span>(sir_out),<span class="st">"time"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plotting the model output</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sir_out_long,<span class="fu">aes</span>(<span class="at">x=</span>time,<span class="at">y=</span>value,<span class="at">colour=</span>variable,<span class="at">group=</span>variable))<span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">2</span>)<span class="sc">+</span>             <span class="co">#Add line</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time"</span>)<span class="sc">+</span><span class="fu">ylab</span>(<span class="st">"Number"</span>)   <span class="co">#Add labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="SIR_Model_EXERCISE_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Now, introduce an infectious person by changing <span class="math inline">\(I_{0}\)</span> = 1 and the values from the parameter table above into the model below. Run the model to calculate the number of individuals in S, I, and R compartments from t=1 to t=100. To answer the following questions you can examine the model output in the data frame sir_out and the plot.</li>
</ul>
</section>
<section id="question-6-1pt" class="level2">
<h2 class="anchored" data-anchor-id="question-6-1pt">Question 6 <strong>(1pt)</strong></h2>
<ul>
<li><p>When does the epidemic peak? When does it end?</p></li>
<li><p>Does everyone get eventually infected? If not, why? <em>Hint: Think about this in terms of the <strong>effective</strong> reproductive number</em> <span class="math inline">\(R_{e}\)</span>?</p></li>
<li><p><strong>ANSWER</strong></p></li>
</ul>
</section>
<section id="question-7-1pt" class="level2">
<h2 class="anchored" data-anchor-id="question-7-1pt">Question 7 <strong>(1pt)</strong></h2>
<ul>
<li><p>Now, let’s say that some residents of Zubrowka had returned from a neighboring country and had immunity from exposure there. Lower <span class="math inline">\(S_{0}\)</span> to reflect this, but keep the total population size, N, the same.</p></li>
<li><p>Is there a threshold at which an epidemic does not occur? If so, what is it and why? You can solve this mathematically (i.e., analytically) but also try it out in the model.</p>
<ul>
<li><em>Hint: Again, consider the effective reproductive number,</em> <span class="math inline">\(R_{e}\)</span></li>
</ul></li>
<li><p><strong>ANSWER</strong></p></li>
</ul>
</section>
<section id="question-8-1pt" class="level2">
<h2 class="anchored" data-anchor-id="question-8-1pt">Question 8 <strong>(1pt)</strong></h2>
<ul>
<li><p>Set the parameters back to the original values and now add some <strong>simple demography</strong>. Assume that people are entering and leaving the population in a balanced death and birth rate.</p></li>
<li><p>Set the birth and death rate, <span class="math inline">\(\mu\)</span>, to 0.1 per day. Also try other values. What happens now? How does changing the birth/death rate, <span class="math inline">\(\mu\)</span>, affect <span class="math inline">\(R_{0}\)</span>? How does it affect the equilibrium and why?</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define parameters -- THESE ARE THE MODEL PARAMETERS</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">alpha =</span><span class="dv">5</span>,        <span class="co"># alpha = daily contacts</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">beta=</span><span class="fl">0.1</span>,        <span class="co"># beta = probability of infection on contact</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">sigma=</span><span class="fl">0.2</span>,       <span class="co"># sigma = rate of recovery per day</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">mu =</span> <span class="fl">0.1</span>,        <span class="co"># mu =  per capita birth and death rate</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">omega =</span> <span class="fl">0.0</span>)     <span class="co"># omega = rate of immune loss per day</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial conditions --  THESE ARE THE CONDITIONS AT THE START OF THE SIMULATION</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S=</span><span class="dv">99</span>,           <span class="co"># number initially susceptible</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">I=</span><span class="dv">1</span>,            <span class="co"># number initially infectious</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">R=</span><span class="dv">0</span>)            <span class="co"># initially immune or "recovered"</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Define model equations -- do not change -- or change with care!</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># These are the model equations.  They are written as a function called sir_ode.  </span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># "parms" and "init" input the parameters and initial conditions into the equations </span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>sir_ode <span class="ot">&lt;-</span> <span class="cf">function</span>(times,init,parms){</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(parms,init)), {</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ODEs</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    dS <span class="ot">&lt;-</span> mu<span class="sc">*</span>(S<span class="sc">+</span>I<span class="sc">+</span>R) <span class="sc">+</span> omega<span class="sc">*</span>R <span class="sc">-</span>alpha<span class="sc">*</span>beta<span class="sc">*</span>I<span class="sc">*</span>S<span class="sc">/</span>(S<span class="sc">+</span>I<span class="sc">+</span>R) <span class="sc">-</span> mu<span class="sc">*</span>S </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    dI <span class="ot">&lt;-</span> alpha<span class="sc">*</span>beta<span class="sc">*</span>I<span class="sc">*</span>S<span class="sc">/</span>(S<span class="sc">+</span>I<span class="sc">+</span>R)<span class="sc">-</span>sigma<span class="sc">*</span>I <span class="sc">-</span> mu<span class="sc">*</span>I</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    dR <span class="ot">&lt;-</span> sigma<span class="sc">*</span>I  <span class="sc">-</span> omega<span class="sc">*</span>R <span class="sc">-</span> mu<span class="sc">*</span>R</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="fu">c</span>(dS,dI,dR))</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co"># This creates the output from model equations.  </span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">#If you want to run the model for longer, change the second term eg: seq(0,200,...)</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">100</span>,<span class="at">length.out=</span><span class="dv">101</span>)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>sir_out <span class="ot">&lt;-</span> <span class="fu">lsoda</span>(init,times,sir_ode,parms)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>sir_out_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(<span class="fu">as.data.frame</span>(sir_out),<span class="st">"time"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plotting the model output</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sir_out_long,<span class="fu">aes</span>(<span class="at">x=</span>time,<span class="at">y=</span>value,<span class="at">colour=</span>variable,<span class="at">group=</span>variable))<span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">2</span>)<span class="sc">+</span>             <span class="co">#Add line</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time"</span>)<span class="sc">+</span><span class="fu">ylab</span>(<span class="st">"Number"</span>)   <span class="co">#Add labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="SIR_Model_EXERCISE_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><strong>ANSWER</strong></li>
</ul>
</section>
<section id="question-9-1pt" class="level2">
<h2 class="anchored" data-anchor-id="question-9-1pt">Question 9 <strong>(1pt)</strong></h2>
<ul>
<li><p>Now, we will also allow immunity to wane by changing <span class="math inline">\(\omega\)</span> to a value greater than 0.</p></li>
<li><p>Choose parameter values that keep <span class="math inline">\(R_{0}\)</span> bigger than 1 (e.g.&nbsp;<span class="math inline">\(\omega\)</span> = 0.05/day). How does adding this extra process affect the dynamics?</p></li>
<li><p><em>Hint: You may wish to increase the span of simulation by changing this line of code in the model code below:</em></p>
<ul>
<li>times &lt;- seq(0,100,length.out=100) by replacing <em>100</em> with <em>500</em> days</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define parameters -- THESE ARE THE MODEL PARAMETERS</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">alpha =</span><span class="dv">5</span>,        <span class="co"># alpha = daily contacts</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">beta=</span><span class="fl">0.1</span>,        <span class="co"># beta = probability of infection on contact</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">sigma=</span><span class="fl">0.2</span>,       <span class="co"># sigma = rate of recovery per day</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">mu =</span> <span class="fl">0.0</span>,        <span class="co"># mu =  per capita birth and death rate</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">omega =</span> <span class="fl">0.05</span>)     <span class="co"># omega = rate of immune loss per day</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial conditions --  THESE ARE THE CONDITIONS AT THE START OF THE SIMULATION</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S=</span><span class="dv">99</span>,           <span class="co"># number initially susceptible</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">I=</span><span class="dv">1</span>,            <span class="co"># number initially infectious</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">R=</span><span class="dv">0</span>)            <span class="co"># initially immune or "recovered"</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Define model equations -- do not change -- or change with care!</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># These are the model equations.  They are written as a function called sir_ode.  </span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># "parms" and "init" input the parameters and initial conditions into the equations </span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>sir_ode <span class="ot">&lt;-</span> <span class="cf">function</span>(times,init,parms){</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(parms,init)), {</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ODEs</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    dS <span class="ot">&lt;-</span> mu<span class="sc">*</span>(S<span class="sc">+</span>I<span class="sc">+</span>R) <span class="sc">+</span> omega<span class="sc">*</span>R <span class="sc">-</span>alpha<span class="sc">*</span>beta<span class="sc">*</span>I<span class="sc">*</span>S<span class="sc">/</span>(S<span class="sc">+</span>I<span class="sc">+</span>R) <span class="sc">-</span> mu<span class="sc">*</span>S </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    dI <span class="ot">&lt;-</span> alpha<span class="sc">*</span>beta<span class="sc">*</span>I<span class="sc">*</span>S<span class="sc">/</span>(S<span class="sc">+</span>I<span class="sc">+</span>R)<span class="sc">-</span>sigma<span class="sc">*</span>I <span class="sc">-</span> mu<span class="sc">*</span>I</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    dR <span class="ot">&lt;-</span> sigma<span class="sc">*</span>I  <span class="sc">-</span> omega<span class="sc">*</span>R <span class="sc">-</span> mu<span class="sc">*</span>R</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="fu">c</span>(dS,dI,dR))</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co"># This creates the output from model equations.  </span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co">#If you want to run the model for longer, change the second term eg: seq(0,200,...)</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">500</span>,<span class="at">length.out=</span><span class="dv">500</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>sir_out <span class="ot">&lt;-</span> <span class="fu">lsoda</span>(init,times,sir_ode,parms)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>sir_out_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(<span class="fu">as.data.frame</span>(sir_out),<span class="st">"time"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plotting the model output</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sir_out_long,<span class="fu">aes</span>(<span class="at">x=</span>time,<span class="at">y=</span>value,<span class="at">colour=</span>variable,<span class="at">group=</span>variable))<span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">lwd=</span><span class="dv">2</span>)<span class="sc">+</span>             <span class="co">#Add line</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time"</span>)<span class="sc">+</span><span class="fu">ylab</span>(<span class="st">"Number"</span>)   <span class="co">#Add labels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="SIR_Model_EXERCISE_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="384"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><strong>ANSWER</strong></li>
</ul>
</section>
<section id="question-10-1pt" class="level2">
<h2 class="anchored" data-anchor-id="question-10-1pt">Question 10 <strong>(1pt)</strong></h2>
<ul>
<li><p><span class="math inline">\(R_{e}\)</span> is defined as the average number of secondary infections produced by an infectious person at any given time <em>e</em>. What is the value of <span class="math inline">\(R_{e}\)</span> when the infection has attained the endemic equilibrium? How does the duration of immunity affect <span class="math inline">\(R_{e}\)</span>? What does this mean? (0.5pt)</p></li>
<li><p><strong>ANSWER</strong></p></li>
</ul>
</section>
<section id="extensions" class="level2">
<h2 class="anchored" data-anchor-id="extensions">Extensions</h2>
<ul>
<li>The model(s) you have used so far in this exercise, even though simple, captures quite well many observed patterns of infections in human populations. Still, models can be extended to include a variety of complexities.</li>
<li>Consider how you would model interventions in this model, such as:
<ul>
<li>social distancing?</li>
<li>vaccination?</li>
<li>demographic dynamics (i.e.&nbsp;when birth is different that death rate)?</li>
<li>an infection with a carrier state?</li>
</ul></li>
</ul>
</section>
<section id="extra-credit-0.5pt" class="level2">
<h2 class="anchored" data-anchor-id="extra-credit-0.5pt">Extra credit <strong>(0.5pt)</strong></h2>
<ul>
<li>Which of these complexities can be incorporated into the model without structural changes to the model. In other words, what can we incorporate by changing parameter values only and not changing the equations?</li>
<li><strong>ANSWER</strong></li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>